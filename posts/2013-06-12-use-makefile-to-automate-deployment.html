<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="本博客提供我个人的想法，创意，经验，心得。你不必认同博主观点。" />
    <meta name="keywords" content="创业, 思想, 点子, 经验, python, erlang, node, javascript, 服务器, devops, meteor" />
    <meta name="author" content="Tyr Chen" />

    <!-- Output DocPad produced meta elements -->
    

    <!-- Styles -->
    <link  rel="stylesheet" href="/assets/css/app.min.css" />

    <link href="/assets/favicon.ico" rel="shortcut icon">
    <link href="/assets/apple-touch-icon.png" rel="apple-touch-icon">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    @javascript html5shiv respond.min
    <![endif]-->

    <title>使用Makefile自动化部署 | 觅珠人 | Tyr Chen的个人博客 | 创意 | 心得 | 经验</title>

</head>

<body>

<!-- Contact Modal -->
<div aria-hidden='true' aria-labelledby='contactModalLabel' class='modal fade' id='contactModal' role='dialog' tabindex='-1'>
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class='modal-header'>
                <button aria-hidden='true' class='close' data-dismiss='modal' type='button'>×</button>
                <h4 class='modal-title'>Contact Us Form</h4>
            </div>
            <div class='modal-body'>
                <form action='#' role='form'>
                    <div class='form-group'>
                        <div class='row'>
                            <div class='col-md-6'>
                                <label class='control-label' for=''>Your Name</label>
                                <input class='form-control' placeholder='your username' type='text'>
                            </div>
                            <div class='col-md-6'>
                                <label class='control-label' for=''>Your Email</label>
                                <input class='form-control' placeholder='your password' type='text'>
                            </div>
                        </div>
                    </div>
                    <div class='form-group'>
                        <div class='row'>
                            <div class='col-md-12'>
                                <label class='control-label' for=''>Your Message</label>
                                <textarea class='form-control' name='' rows='4'></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-default' data-dismiss='modal' type='button'>Cancel</button>
                <button class='btn btn-primary' type='button'>Send Message</button>
            </div>
        </div>
    </div>
</div>

<div class="header-image-wrapper">
  <img alt="" src="/assets/files/posts/automation.jpg">
</div>

<div class='header-main'>
    <div class='container'>
        <nav class='navbar navbar-default' role='navigation'>
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class='navbar-header'>
                <button class='navbar-toggle' data-target='.navbar-ex1-collapse' data-toggle='collapse' type='button'>
                    <span class='sr-only'>Toggle navigation</span>
                    <span class='icon-bar'></span>
                    <span class='icon-bar'></span>
                    <span class='icon-bar'></span>
                </button>
                <a class='navbar-brand' href='/'>
                    <img alt='' height='45px' src='/assets/images/tyr.png'> <span>觅珠人</span>
                </a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class='collapse navbar-collapse navbar-ex1-collapse'>

                <ul class='nav navbar-nav navbar-right'>
                    <li class="">
                        <a href="/">首页</a>
                    </li>
                    
                        
                        <li
                            about="/pages/posts.html"
                            class=""
                        >
                            <a href="/pages/posts.html">
                                文章随笔
                            </a>
                        </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                        <li
                            about="/pages/canvases.html"
                            class=""
                        >
                            <a href="/pages/canvases.html">
                                奇思妙想
                            </a>
                        </li>
                        
                    
                        
                        <li
                            about="/pages/aboutme.html"
                            class=""
                        >
                            <a href="/pages/aboutme.html">
                                关于我
                            </a>
                        </li>
                        
                    
                    <!--
                    <li>
                        <a data-toggle='modal' href='#contactModal'>联系我</a>
                    </li>
                    -->
                </ul>
            </div>
        </nav>
    </div>
</div>
</div>

<div class='separator-shadow-bottom'>
    <img alt='' src='/assets/images/shadow-separator-wide-bottom.png'>
</div>

<div class='container'>
  <div class='row'>
    <div class="col-md-3">
      <div class="post-side-bar">
        <div class="widget widget-cats tags">
          <h4 class="widget-title">标签</h4>
          <ul>
          
            <li><a href='/tags/automation.html'>automation</a></li>
          
            <li><a href='/tags/technology.html'>technology</a></li>
          
          </ul>
        </div>
        <div class="widget widget-cats">
          <h4 class="widget-title">
            相关文章
          </h4>
          <ul>
            
            
              <li><a href="/posts/2012-12-31-atanasoff-product-design.html">进一步思考Atanasoff (Octopress client) (2)</a></li>
            
              <li><a href="/posts/2013-04-25-engineering-environment-for-smart-team.html">自动化的高效团队开发环境</a></li>
            
              <li><a href="/posts/2013-01-09-auto-deploy-with-github-webhooks.html">用Github Webhooks实现自动部署</a></li>
            
              <li><a href="/posts/2013-02-18-sdn-elementatory-introduction.html">SDN浅谈</a></li>
            
              <li><a href="/posts/2013-02-21-openflow-introduction.html">Openflow简介</a></li>
            
              <li><a href="/posts/2013-04-08-trying-to-extract-the-thoughts-behind-lockitron.html">胡思乱想之Lockitron的技术架构</a></li>
            
              <li><a href="/posts/2012-12-18-octopress-client-a-better-composition-tool.html">产品随想：octopress客户端 —— Atanasoff</a></li>
            
              <li><a href="/posts/2013-06-10-use-scrapyd-to-serve-scrapy-projects.html">用scrapyd来提供crawler服务</a></li>
            
              <li><a href="/posts/2013-06-23-come-to-origin-for-embedded-applications.html">Come to Origins for Embedded Applications</a></li>
            
              <li><a href="/posts/2013-07-18-c-grammar-you-cannot-imagine.html">你无法想象的C语法</a></li>
            
              <li><a href="/posts/2013-07-22-why-should-c-programmers-learn-erlang.html">Why should C programmers learn Erlang?</a></li>
            
              <li><a href="/posts/2013-10-28-blog-reborn.html">觅珠人：浴火重生</a></li>
            
            
          </ul>
        </div>
      </div>
    </div>      
    <div class='col-md-9'>
      <div class='post-single'>
        <!--
        <div class='pre-post-meta'>
          <span>
            <i class='icon-reorder'></i>
            in
            <a href='#'>Web Development</a>
          </span>
          <span>
            <i class='icon-user'></i>
            by
            <a href='#'>Tyr Chen</a>
          </span>
          <span>
            <i class='icon-bookmark'></i>
            8 分钟
          </span>
        </div>
        -->
        <h1 class='has-sub-header'>使用Makefile自动化部署</h1>
        <div class='post-single-meta'>
          <span class='meta-item'>
            <i class='icon-calendar'></i>
            5个月前
          </span>
          <!--
          <span class='meta-item'>
            <a href='#'>
              <i class='icon-comments'></i>
              24
            </a>
          </span>
          <span class='meta-item'>
            <a href='#'>
              <i class='icon-heart'></i>
              15
            </a>
          </span>
          -->
          <span class="meta-item">
          	
            <i class='icon-time'></i>
            8 分钟
          </span>
        </div>
        <p>有时候，写个小app，部署是件麻烦的事情 —— 你需要登录到服务器上，手工编辑nginx，supervisor等配置文件，然后重启相关的服务。这些配置都不在版本库中，所以也无法记录历史修订。<code>puppet</code> 是个不错的解决方案，但对于小项目来说，使用puppet是个负担。</p>
<p>本文讨论如何通过写个简单的 <code>makefile</code> 来达到自动化部署的目的。</p>
<!--more-->

<h2>本地化服务器配置</h2>
<p>首先要做的是將服务器的配置本地化，放在自己的项目中：</p>
<p><img src="/assets/files/snapshots/project_layout.jpg" alt="项目目录结构"></p>
<p>图中，_deploy目录下的内容就是我们要部署到服务器上的配置，其目录结构和服务器要完全一致，这样可以用 <code>cp</code> 直接將文件拷贝过去：</p>
<section>
<pre><code> $ sudo cp -r _deploy/etc/. /etc/.</code></pre>
</section>
<p>这里有个问题，sudo一般需要输密码，但这里如果停下来等待用户交互，就无法完全自动化了。所以我们需要让 <code>cp</code> 无须password就可以执行。但又引来一个问题：无密码限制的 <code>cp</code> 太危险，可能会导致误操作。所以我们就把 <code>cp</code> copy 一份出来，叫 <code>sucopy</code>，然后对其设置 nopassword:</p>
<section>
<pre><code> $ sudo cp /bin/cp /bin/sucopy
 $ sudo visudo</code></pre>
</section>
<p>在打开的编辑窗口，为当前用户设置 <code>sudo</code> 选项：</p>
<section>
<pre><code> dev ALL=(ALL) NOPASSWD: /usr/bin/supervisorctl, /etc/init.d/nginx, /bin/sucopy, /usr/bin/apt-get</code></pre>
</section>
<p>我这里把 <code>apt-get</code>，<code>supervisorctl</code> 和 <code>nginx</code> 都设置为 <code>NOPASSWD</code>，也是为了自动运行。</p>
<p>注：如果 <code>visudo</code> 使用的nano编辑器不是你的菜，可以用 <code>update-alternatives --config editor</code> 切换成vim。</p>
<p>设置完成后，我们就可以在makefile中用 <code>sucopy</code> 把项目中的配置文件直接更新系统中的对应文件了，比如：</p>
<section>
<pre><code> sudo sucopy -r _deploy/etc/. /etc/.</code></pre>
</section>
<p>很简单吧。这样做的好处是配置文件的修改随着项目文件一起在版本库中控制，部署起来也方便很多。</p>
<p>nginx和supervisor的配置很简单，这里就给个例子，不解释：</p>
<p>nginx配置：</p>
<section>
<pre><code> tchen@tchen-mbp: ~/projects/kahn/_deploy/etc/nginx/sites-available on master$ cat kahn
 server {
   listen 80;
   server_name api.awesome-server.com;
   access_log /var/log/nginx/kahn.access.log;
   error_log /var/log/nginx/kahn.error.log;
   location / {
     proxy_pass http://localhost:6080;
     include /etc/nginx/proxy_params;
   }
 }</code></pre>
<pre><code> tchen@tchen-mbp: ~/projects/kahn/_deploy/etc/nginx/sites-enabled on master$ ls -l
 total 8
 lrwxr-xr-x  1 tchen  522017917  23 Jun 11 13:48 kahn -&gt; ../sites-available/kahn</code></pre>
</section>
<p>supervisor配置：</p>
<section>
<pre><code> tchen@tchen-mbp: ~/projects/kahn/_deploy/etc/supervisor/conf.d on master$ cat kahn.conf
 [program:kahn]
 directory=/home/dev/deployment/kahn
 user=dev
 command=coffee app.coffee
 redirect_stderr=true
 stderr_logfile=none
 stdout_logfile=/var/log/supervisor/kahn.log
 autostart=true
 autorestart=true</code></pre>
</section>
<h2>Makefile</h2>
<p>解决了服务器的本地化配置问题，自动化部署就不在话下。这里只自动化了下列任务，对简单的小项目来说足够了：</p>
<ul>
<li>代码更新。</li>
<li>依赖更新。（python的用户可以把 <code>npm install</code> 换成 <code>pip install -r requirements.txt</code>）</li>
<li>配置更新。</li>
<li>supervisor设置更新及重启。</li>
<li>nginx重启。</li>
</ul>
<p>Makefile文件比较简单，不解释了。注意这里我们把 <code>remote_deploy</code> 放在第一位，让 <code>make</code> 缺省调用时可以调用它，这样，我们会自动登录到服务器上（服务器的连接请使用rsa key，避免输入密码），pull代码，然后执行 <code>make deploy</code> 进行部署。</p>
<section>
<pre><code> tchen@tchen-mbp: ~/projects/kahn on master$ cat Makefile
 CHECK=\033[32m✔\033[39m
 DONE=&quot;\n$(CHECK) Done.\n&quot;

 SERVER=awesome-server.com
 PROJECT=kahn
 PATH=deployment/$(PROJECT)
 SUPERVISORCTL=/usr/bin/supervisorctl
 SUCOPY=/bin/sucopy
 SSH=/usr/bin/ssh
 ECHO=/bin/echo -e
 NPM=/usr/local/bin/npm
 SUDO=/usr/bin/sudo

 remote_deploy:
     @$(SSH) -t $(SERVER) &quot;echo Deploy $(PROJECT) to the $(SERVER) server.; cd $(PATH); git pull; make deploy;&quot;

 dependency:
     @$(ECHO) &quot;\nInstall project dependencies...&quot;
     @$(NPM) install

 configuration:
     @$(ECHO) &quot;\nUpdate configuration...&quot;
     @$(SUDO) $(SUCOPY) -r _deploy/etc/. /etc/.

 supervisor:
     @$(ECHO) &quot;\nUpdate supervisor configuration...&quot;
     @$(SUDO) $(SUPERVISORCTL) reread
     @$(SUDO) $(SUPERVISORCTL) update
     @$(ECHO) &quot;\nRestart $(PROJECT)...&quot;
     @$(SUDO) $(SUPERVISORCTL) restart $(PROJECT)

 nginx:
     @$(ECHO) &quot;\nRestart nginx...&quot;
     @$(SUDO) /etc/init.d/nginx restart

 deploy: dependency configuration supervisor nginx
     @$(ECHO) $(DONE)</code></pre>
</section>
<p>大功告成。试试吧：</p>
<section>
<pre><code> tchen@tchen-mbp: ~/projects/kahn on master$ make
 Deploy kahn to the awesome-server.com server.
 Current branch master is up to date.

 Install project dependencies...

 Update configuration...

 Update supervisor configuration...
 No config updates to processes

 Restart kahn...
 kahn: stopped
 kahn: started

 Restart nginx...
 Restarting nginx: nginx.

 ✔ Done.

 Shared connection to awesome-server.com closed.</code></pre>
</section>
<p>送上小宝的近照一张：</p>
<p><img src="/assets/files/photos/baby20130612.jpg" alt="小宝近期照片"></p>

        <div class='under-post'>
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
                
                  <div class='pull-left'>
                    <a class='read-previous-link' href='/posts/2013-06-10-use-scrapyd-to-serve-scrapy-projects.html'>
                      <i class='icon-angle-left'></i>
                      上一篇
                    </a>
                  </div>                  
                
                
                  <div class='pull-right'>
                    <a class='read-next-link' href='/posts/2013-06-21-entrepreneurship-in-bay-area.html'>
                      下一篇
                      <i class='icon-angle-right'></i>
                    </a>
                  </div>
                         
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          
          <div class='post-social text-center'>
  <a class='social-link' href='#'>
    <i class='icon-facebook'></i>
  </a>
  <a class='social-link' href='#'>
    <i class='icon-twitter'></i>
  </a>
  <a class='social-link' href='#'>
    <i class='icon-linkedin'></i>
  </a>
  <a class='social-link' href='#'>
    <i class='icon-envelope'></i>
  </a>
</div>
        </div>
      </div>
    </div>
    
    <div class='separator-shadow-bottom'>
    <img alt='' src='/assets/images/shadow-separator-wide-bottom.png'>
</div>
    
  <div class="ds-thread">
    <script>
        var duoshuoQuery = {short_name:"tyrchen"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
  </div>

      
  </div>
</div>

<footer id="main-footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <ul class="footer-menu">
                    <li><a href="/pages/privacy">隐私策略</a></li>
                    <li><a href="/pages/license">版权说明</a></li>
                    <li><a href="/pages/disclaimer">免责声明</a></li>
                    <li><a href="#">联系我们</a></li>
                </ul>
                <div class="copyright">
                    2013 &copy; Tyr Chen. 保留一切权利.
                    <script>
                        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
                        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F639096b5979f5825515e0f88f871f56c' type='text/javascript'%3E%3C/script%3E"));
                    </script>
                </div>
            </div>
            <div class="col-md-6">
                <ul class="footer-social">
                    <li><a href="#"><i class="icon-facebook"></i></a></li>
                    <li><a href="#"><i class="icon-twitter"></i></a></li>
                    <li><a href="#"><i class="icon-dribbble"></i></a></li>
                    <li><a href="#"><i class="icon-linkedin"></i></a></li>
                    <li><a href="#"><i class="icon-google-plus"></i></a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>


<!-- Scripts -->
<script defer="defer"  src="/assets/js/app.min.js"></script>


</body>

</html>