<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="本博客提供我个人的想法，创意，经验，心得。你不必认同博主观点。" />
    <meta name="keywords" content="创业, 思想, 点子, 经验, python, erlang, node, javascript, 服务器, devops, meteor" />
    <meta name="author" content="Tyr Chen" />

    <!-- Output DocPad produced meta elements -->
    

    <!-- Styles -->
    <link  rel="stylesheet" href="/assets/css/app.min.css" />

    <link href="/assets/favicon.ico" rel="shortcut icon">
    <link href="/assets/apple-touch-icon.png" rel="apple-touch-icon">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>

    <![endif]-->

    <title>你无法想象的C语法 | 觅珠人 | Tyr Chen的个人博客 | 创意 | 心得 | 经验</title>

</head>

<body>

<!-- Contact Modal -->
<div aria-hidden='true' aria-labelledby='contactModalLabel' class='modal fade' id='contactModal' role='dialog' tabindex='-1'>
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class='modal-header'>
                <button aria-hidden='true' class='close' data-dismiss='modal' type='button'>×</button>
                <h4 class='modal-title'>Contact Us Form</h4>
            </div>
            <div class='modal-body'>
                <form action='#' role='form'>
                    <div class='form-group'>
                        <div class='row'>
                            <div class='col-md-6'>
                                <label class='control-label' for=''>Your Name</label>
                                <input class='form-control' placeholder='your username' type='text'>
                            </div>
                            <div class='col-md-6'>
                                <label class='control-label' for=''>Your Email</label>
                                <input class='form-control' placeholder='your password' type='text'>
                            </div>
                        </div>
                    </div>
                    <div class='form-group'>
                        <div class='row'>
                            <div class='col-md-12'>
                                <label class='control-label' for=''>Your Message</label>
                                <textarea class='form-control' name='' rows='4'></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-default' data-dismiss='modal' type='button'>Cancel</button>
                <button class='btn btn-primary' type='button'>Send Message</button>
            </div>
        </div>
    </div>
</div>

<div class="header-image-wrapper">
  <img alt="" src="/assets/files/posts/gears.jpg">
</div>

<div class='header-main'>
    <div class='container'>
        <nav class='navbar navbar-default' role='navigation'>
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class='navbar-header'>
                <button class='navbar-toggle' data-target='.navbar-ex1-collapse' data-toggle='collapse' type='button'>
                    <span class='sr-only'>Toggle navigation</span>
                    <span class='icon-bar'></span>
                    <span class='icon-bar'></span>
                    <span class='icon-bar'></span>
                </button>
                <a class='navbar-brand' href='/'>
                    <img alt='' height='45px' src='/assets/images/tyr.png'> <span>觅珠人</span>
                </a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class='collapse navbar-collapse navbar-ex1-collapse'>

                <ul class='nav navbar-nav navbar-right'>
                    <li class="">
                        <a href="/">首页</a>
                    </li>
                    
                        
                        <li
                            about="/pages/posts.html"
                            class=""
                        >
                            <a href="/pages/posts.html">
                                文章随笔
                            </a>
                        </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                        <li
                            about="/pages/canvases.html"
                            class=""
                        >
                            <a href="/pages/canvases.html">
                                奇思妙想
                            </a>
                        </li>
                        
                    
                        
                        <li
                            about="/pages/aboutme.html"
                            class=""
                        >
                            <a href="/pages/aboutme.html">
                                关于我
                            </a>
                        </li>
                        
                    
                    <!--
                    <li>
                        <a data-toggle='modal' href='#contactModal'>联系我</a>
                    </li>
                    -->
                </ul>
            </div>
        </nav>
    </div>
</div>
</div>

<div class='separator-shadow-bottom'>
    <img alt='' src='/assets/images/shadow-separator-wide-bottom.png'>
</div>

<div class='container'>
  <div class='row'>
    <div class="col-md-3">
      <div class="post-side-bar">
        <!--
        <div class="widget widget-author">
          <div class="author-avatar">
            <img alt="" src="/assets/images/tyr.png">
          </div>
          <div class="author-meta">
            <h4 class="author-name">Tyr Chen</h4>
            <p class="author-bio">Progressively maintain extensive infomediaries via extensible niches.</p>
            
            <a class="author-more" href="#">
              read more posts
              <i class="icon-angle-right"></i>
            </a>
          </div>
        </div>
        -->
        <div class="widget widget-cats tags">
          <h4 class="widget-title">标签</h4>
          <ul>
          
            <li><a href='/tags/c.html'>c</a></li>
          
            <li><a href='/tags/lang.html'>lang</a></li>
          
            <li><a href='/tags/technology.html'>technology</a></li>
          
          </ul>
        </div>
        <div class="widget widget-cats">
          <h4 class="widget-title">
            相关文章
          </h4>
          <ul>
            
            
              <li><a href="/posts/2013-06-12-use-makefile-to-automate-deployment.html">使用Makefile自动化部署</a></li>
            
              <li><a href="/posts/2012-12-18-octopress-client-a-better-composition-tool.html">产品随想：octopress客户端 —— Atanasoff</a></li>
            
              <li><a href="/posts/2013-01-06-io-lang.html">有意思的Io语言（一）</a></li>
            
              <li><a href="/posts/2013-02-18-sdn-elementatory-introduction.html">SDN浅谈</a></li>
            
              <li><a href="/posts/2013-02-21-openflow-introduction.html">Openflow简介</a></li>
            
              <li><a href="/posts/2013-04-08-trying-to-extract-the-thoughts-behind-lockitron.html">胡思乱想之Lockitron的技术架构</a></li>
            
              <li><a href="/posts/2013-04-25-engineering-environment-for-smart-team.html">自动化的高效团队开发环境</a></li>
            
              <li><a href="/posts/2013-06-10-use-scrapyd-to-serve-scrapy-projects.html">用scrapyd来提供crawler服务</a></li>
            
              <li><a href="/posts/2012-12-31-atanasoff-product-design.html">进一步思考Atanasoff (Octopress client) (2)</a></li>
            
              <li><a href="/posts/2013-06-23-come-to-origin-for-embedded-applications.html">Come to Origins for Embedded Applications</a></li>
            
              <li><a href="/posts/2013-07-22-why-should-c-programmers-learn-erlang.html">Why should C programmers learn Erlang?</a></li>
            
              <li><a href="/posts/2013-10-28-blog-reborn.html">觅珠人：浴火重生</a></li>
            
              <li><a href="/posts/2013-10-30-the-hatch-project.html">Hatch: 又一个建站工具</a></li>
            
              <li><a href="/posts/2013-11-03-hatch-experiment.html">Hatch: 实验</a></li>
            
              <li><a href="/posts/2013-11-11-https.html">使用HTTPS</a></li>
            
              <li><a href="/posts/2013-11-13-local-docker-repo-en.html">Build Your Own Docker Registry with DigitalOcean</a></li>
            
              <li><a href="/posts/2013-11-13-local-docker-repo.html">建立自己的docker repository</a></li>
            
            
          </ul>
        </div>
      </div>
    </div>      
    <div class='col-md-9'>
      <div class='post-single'>
        <!--
        <div class='pre-post-meta'>
          <span>
            <i class='icon-tags'></i>
            in
            <a href='#'>Web Development</a>
          </span>
          <span>
            <i class='icon-user'></i>
            by
            <a href='#'>Tyr Chen</a>
          </span>
          <span>
            <i class='icon-bookmark'></i>
            9 分钟
          </span>
        </div>
        -->
        <h1 class='has-sub-header'>你无法想象的C语法</h1>
        <div class='post-single-meta'>
          <span class='meta-item'>
            <i class='icon-calendar'></i>
            7个月前
          </span>
          <!--
          <span class='meta-item'>
            <a href='#'>
              <i class='icon-comments'></i>
              24
            </a>
          </span>
          <span class='meta-item'>
            <a href='#'>
              <i class='icon-heart'></i>
              15
            </a>
          </span>
          -->
          <span class="meta-item">
          	
            <i class='icon-time'></i>
            9 分钟
          </span>
        </div>
        <h2>引子</h2>
<p>看了berkeley网站上的文章<a href="http://www.cs.berkeley.edu/~necula/cil/cil016.html">Who Says C is Simple?</a>，顿感汗流浃背。如果招聘官按照这个题目去面试，我也就将将五十分。不过话说回来，这里所列的case都太偏门，走的是圣火令的武功路数，真正做工程的这么写代码就是欠揍。</p>
<p>但是抱着学语言的态度，这里的题目如果你不懂都值得深究。我研究了下第四题 —— 这是让我比较困惑的一题。</p>
<pre><code>// Functions and function pointers are implicitly converted to each other.
int (*pf)(void);
int f(void) {

   pf = &amp;f; // This looks ok
   pf = ***f; // Dereference a function?
   pf(); // Invoke a function pointer?     
   (****pf)();  // Looks strange but Ok
   (***************f)(); // Also Ok             
}</code></pre>
<!--more-->

<h2>探讨</h2>
<p>这个代码直接运行的话肯定是Segment Fault。从第3句起就是个无限递归。作者想揭示的问题并不在此，所以我的测试代码做了小小修改：</p>
<pre><code>#include &lt;stdio.h&gt;

int (*pf)(void);

int f(void) {
    printf(&quot;Hello world!\n&quot;);
}

int main() {
    f();
    (&amp;f)();
    (*f)();
    (************f)();
    pf = &amp;f;
    pf();
    pf = *f;
    pf();
}</code></pre>
<p>运行起来和预期一致：</p>
<pre><code>vagrant@vagrant-ubuntu-raring-64:~/arena$ ./fp
Hello world!
Hello world!
Hello world!
Hello world!
Hello world!
Hello world!</code></pre>
<p>我们来看看汇编出来的结果（arm）：</p>
<pre><code>00008440 &lt;f&gt;:
    8440:   e92d4800    push    {fp, lr}
    8444:   e28db004    add fp, sp, #4
    8448:   e59f0008    ldr r0, [pc, #8]    ; 8458 &lt;f+0x18&gt;
    844c:   ebffffa2    bl  82dc &lt;_init+0x20&gt;
    8450:   e1a00003    mov r0, r3
    8454:   e8bd8800    pop {fp, pc}
    8458:   00008528    .word   0x00008528

0000845c &lt;main&gt;:
    845c:   e92d4800    push    {fp, lr}
    8460:   e28db004    add fp, sp, #4
    8464:   ebfffff5    bl  8440 &lt;f&gt;
    8468:   ebfffff4    bl  8440 &lt;f&gt;
    846c:   ebfffff3    bl  8440 &lt;f&gt;
    8470:   ebfffff2    bl  8440 &lt;f&gt;
    8474:   e59f3030    ldr r3, [pc, #48]   ; 84ac &lt;main+0x50&gt;
    8478:   e59f2030    ldr r2, [pc, #48]   ; 84b0 &lt;main+0x54&gt;
    847c:   e5832000    str r2, [r3]
    8480:   e59f3024    ldr r3, [pc, #36]   ; 84ac &lt;main+0x50&gt;
    8484:   e5933000    ldr r3, [r3]
    8488:   e12fff33    blx r3
    848c:   e59f3018    ldr r3, [pc, #24]   ; 84ac &lt;main+0x50&gt;
    8490:   e59f2018    ldr r2, [pc, #24]   ; 84b0 &lt;main+0x54&gt;
    8494:   e5832000    str r2, [r3]
    8498:   e59f300c    ldr r3, [pc, #12]   ; 84ac &lt;main+0x50&gt;
    849c:   e5933000    ldr r3, [r3]
    84a0:   e12fff33    blx r3
    84a4:   e1a00003    mov r0, r3
    84a8:   e8bd8800    pop {fp, pc}
    84ac:   0001102c    .word   0x0001102c
    84b0:   00008440    .word   0x00008440</code></pre>
<p>我们可以看到 <code>f()</code>，<code>(&amp;f)()</code>，<code>(*f)()</code>，<code>(************f)()</code> 编译出来的结果均为 <code>bl 8440 &lt;f&gt;</code>。而无论对 <code>pf</code> 赋值为 <code>&amp;f</code>，还是 <code>*f</code>，其代码都是：</p>
<pre><code>    8474:   e59f3030    ldr r3, [pc, #48]   ; 84ac &lt;main+0x50&gt;
    8478:   e59f2030    ldr r2, [pc, #48]   ; 84b0 &lt;main+0x54&gt;
    847c:   e5832000    str r2, [r3]
    8480:   e59f3024    ldr r3, [pc, #36]   ; 84ac &lt;main+0x50&gt;
    8484:   e5933000    ldr r3, [r3]
    8488:   e12fff33    blx r3</code></pre>
<p>这个代码很好理解，就是把 <code>f()</code> 的地址取出来，存入 <code>pf</code>，然后执行 <code>pf()</code>（注意arm会把全局地址存放在使用它的函数的末尾，这样可以一条指令取出地址）。问题是，为何 <code>&amp;f</code> 和 <code>*f</code> 在这里是等价的？</p>
<h2>*和&amp;</h2>
<p>我们知道，<code>*</code> 是解引用，<code>&amp;</code> 是引用，下面的代码，前者取值，后者取地址：</p>
<pre><code>#include &lt;stdio.h&gt;

int print(int x)
{
    printf(&quot;value is %x\n&quot;, x);
}

int main()
{
    int a;
    int b;
    unsigned int x[] = {0x10};

    a = *x;
    b = &amp;x;

    print(a);
    print(b);
    print(x);

}</code></pre>
<p>执行结果说明一切：</p>
<pre><code>vagrant@vagrant-ubuntu-raring-64:~/arena$ ./a.out
value is 10
value is f50cef80
value is f50cef80</code></pre>
<p>汇编代码也和预期一致：</p>
<pre><code>    00008470 &lt;main&gt;:
    8470:   e92d4800    push    {fp, lr}
    8474:   e28db004    add fp, sp, #4
    8478:   e24dd010    sub sp, sp, #16
    847c:   e3a03010    mov r3, #16
    8480:   e50b3010    str r3, [fp, #-16]
    8484:   e51b3010    ldr r3, [fp, #-16]
    8488:   e50b300c    str r3, [fp, #-12]
    848c:   e24b3010    sub r3, fp, #16
    8490:   e50b3008    str r3, [fp, #-8]
    8494:   e51b000c    ldr r0, [fp, #-12]
    8498:   ebffffe9    bl  8444 &lt;print&gt;
    849c:   e51b0008    ldr r0, [fp, #-8]
    84a0:   ebffffe7    bl  8444 &lt;print&gt;
    84a4:   e24b3010    sub r3, fp, #16
    84a8:   e1a00003    mov r0, r3
    84ac:   ebffffe4    bl  8444 &lt;print&gt;
    84b0:   e1a00003    mov r0, r3
    84b4:   e24bd004    sub sp, fp, #4
    84b8:   e8bd8800    pop {fp, pc}</code></pre>
<p>那么，同样是对地址（<code>f()</code>也是个地址）做解引用(<code>*</code>)，为何作用于函数地址，解引用等同于引用？</p>
<p>我的理解是，对于函数地址的解引用，如何和数组等同处理，返回对应地址的内容，即编译出来的机器码，是能够解释 <code>(*f)()</code>的。因为返回的代码被执行后，<code>pc</code> 会自增，然后代码就顺着函数的逻辑执行下去，这个没有问题。所以，<code>(*f)()</code> 等价于 <code>f()</code>，同样等价于 <code>(&amp;f)()</code>。但问题是如何理解 <code>(*******f)()</code>？貌似任意多的解引用作用于函数地址，编译器并不会报错且运行正常，而 <code>(&amp;&amp;&amp;f)()</code> 编都编不过？</p>
<p>费了好大劲，想花了脑袋都没想明白。求助于stackoverflow，发现有人也有类似的疑问：<a href="http://stackoverflow.com/questions/2795575/how-does-dereferencing-of-a-function-pointer-happen">How does dereferencing of a function pointer happen?</a>，最佳答案通过lvalue和rvalue的角度去分析，看着很靠谱，值得一读，我这里就不重复了。</p>
<h2>后记</h2>
<p>学语言，如果抱着一颗写编译器的心去学，那么就无敌于天下了。:)</p>
<p><img src="/assets/files/photos/baby20130711.jpg" alt="小宝和爷爷"></p>

        <div class='under-post'>
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
                
                  <div class='pull-left'>
                    <a class='read-previous-link' href='/posts/2013-06-23-come-to-origin-for-embedded-applications.html'>
                      <i class='icon-angle-left'></i>
                      上一篇
                    </a>
                  </div>                  
                
                
                  <div class='pull-right'>
                    <a class='read-next-link' href='/posts/2013-07-22-why-should-c-programmers-learn-erlang.html'>
                      下一篇
                      <i class='icon-angle-right'></i>
                    </a>
                  </div>
                         
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          
          <div class='post-social text-center'>
  <a class='social-link' href='#'>
    <i class='icon-weibo'></i>
  </a>
  <a class='social-link' href='#'>
    <i class='icon-envelope'></i>
  </a>
</div>
        </div>
        <div class='separator-shadow-bottom'>
    <img alt='' src='/assets/images/shadow-separator-wide-bottom.png'>
</div>
        
  <div class="ds-thread">
    <script>
        var duoshuoQuery = {short_name:"tyrchen"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
  </div>

    
      </div>
    </div>


  </div>
</div>

<footer id="main-footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <ul class="footer-menu">
                    <li><a href="/pages/privacy">隐私策略</a></li>
                    <li><a href="/pages/license">版权说明</a></li>
                    <li><a href="/pages/disclaimer">免责声明</a></li>
                    <li><a href="#">联系我们</a></li>
                </ul>
                <div class="copyright">
                    2014 &copy; Tyr Chen. 保留一切权利.
                    <script>
                        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
                        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F639096b5979f5825515e0f88f871f56c' type='text/javascript'%3E%3C/script%3E"));
                    </script>
                </div>
            </div>
            <div class="col-md-6">
                <ul class="footer-social">
                
                    <li><a href="tyr.chen{#}gmail.com" target="_blank"><i class="icon-envelope"></i></a></li>
                
                    <li><a href="http://weibo.com/tchen82" target="_blank"><i class="icon-weibo"></i></a></li>
                
                    <li><a href="http://github.com/tyrchen" target="_blank"><i class="icon-github"></i></a></li>
                
                    <li><a href="http://linkedin.com/in/tyrchen/" target="_blank"><i class="icon-linkedin"></i></a></li>
                
                    <li><a href="https://twitter.com/tyrchen" target="_blank"><i class="icon-twitter"></i></a></li>
                
                    <li><a href="https://www.facebook.com/tyrchen" target="_blank"><i class="icon-facebook"></i></a></li>
                
                    <li><a href="https://plus.google.com/114684266209262341260/" target="_blank"><i class="icon-google-plus"></i></a></li>
                
                </ul>
            </div>
        </div>
    </div>
</footer>

<!-- Scripts -->
<script defer="defer"  src="/assets/js/app.min.js"></script>

<script defer="defer" language="javascript">

</script>
</body>

</html>