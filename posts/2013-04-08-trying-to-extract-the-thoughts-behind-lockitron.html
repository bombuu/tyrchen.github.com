<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="本博客提供我个人的想法，创意，经验，心得。你不必认同博主观点。" />
    <meta name="keywords" content="创业, 思想, 点子, 经验, python, erlang, node, javascript, 服务器, devops, meteor" />
    <meta name="author" content="Tyr Chen" />

    <!-- Output DocPad produced meta elements -->
    

    <!-- Styles -->
    <link  rel="stylesheet" href="/assets/css/app.min.css" />

    <link href="/assets/favicon.ico" rel="shortcut icon">
    <link href="/assets/apple-touch-icon.png" rel="apple-touch-icon">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>

    <![endif]-->

    <title>胡思乱想之Lockitron的技术架构 | 觅珠人 | Tyr Chen的个人博客 | 创意 | 心得 | 经验</title>

</head>

<body>

<!-- Contact Modal -->
<div aria-hidden='true' aria-labelledby='contactModalLabel' class='modal fade' id='contactModal' role='dialog' tabindex='-1'>
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class='modal-header'>
                <button aria-hidden='true' class='close' data-dismiss='modal' type='button'>×</button>
                <h4 class='modal-title'>Contact Us Form</h4>
            </div>
            <div class='modal-body'>
                <form action='#' role='form'>
                    <div class='form-group'>
                        <div class='row'>
                            <div class='col-md-6'>
                                <label class='control-label' for=''>Your Name</label>
                                <input class='form-control' placeholder='your username' type='text'>
                            </div>
                            <div class='col-md-6'>
                                <label class='control-label' for=''>Your Email</label>
                                <input class='form-control' placeholder='your password' type='text'>
                            </div>
                        </div>
                    </div>
                    <div class='form-group'>
                        <div class='row'>
                            <div class='col-md-12'>
                                <label class='control-label' for=''>Your Message</label>
                                <textarea class='form-control' name='' rows='4'></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-default' data-dismiss='modal' type='button'>Cancel</button>
                <button class='btn btn-primary' type='button'>Send Message</button>
            </div>
        </div>
    </div>
</div>

<div class="header-image-wrapper">
  <img alt="" src="/assets/files/canvases/lockitron.jpg">
</div>

<div class='header-main'>
    <div class='container'>
        <nav class='navbar navbar-default' role='navigation'>
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class='navbar-header'>
                <button class='navbar-toggle' data-target='.navbar-ex1-collapse' data-toggle='collapse' type='button'>
                    <span class='sr-only'>Toggle navigation</span>
                    <span class='icon-bar'></span>
                    <span class='icon-bar'></span>
                    <span class='icon-bar'></span>
                </button>
                <a class='navbar-brand' href='/'>
                    <img alt='' height='45px' src='/assets/images/tyr.png'> <span>觅珠人</span>
                </a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class='collapse navbar-collapse navbar-ex1-collapse'>

                <ul class='nav navbar-nav navbar-right'>
                    <li class="">
                        <a href="/">首页</a>
                    </li>
                    
                        
                        <li
                            about="/pages/posts.html"
                            class=""
                        >
                            <a href="/pages/posts.html">
                                文章随笔
                            </a>
                        </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                        <li
                            about="/pages/canvases.html"
                            class=""
                        >
                            <a href="/pages/canvases.html">
                                奇思妙想
                            </a>
                        </li>
                        
                    
                        
                        <li
                            about="/pages/aboutme.html"
                            class=""
                        >
                            <a href="/pages/aboutme.html">
                                关于我
                            </a>
                        </li>
                        
                    
                    <!--
                    <li>
                        <a data-toggle='modal' href='#contactModal'>联系我</a>
                    </li>
                    -->
                </ul>
            </div>
        </nav>
    </div>
</div>
</div>

<div class='separator-shadow-bottom'>
    <img alt='' src='/assets/images/shadow-separator-wide-bottom.png'>
</div>

<div class='container'>
  <div class='row'>
    <div class="col-md-3">
      <div class="post-side-bar">
        <!--
        <div class="widget widget-author">
          <div class="author-avatar">
            <img alt="" src="/assets/images/tyr.png">
          </div>
          <div class="author-meta">
            <h4 class="author-name">Tyr Chen</h4>
            <p class="author-bio">Progressively maintain extensive infomediaries via extensible niches.</p>
            
            <a class="author-more" href="#">
              read more posts
              <i class="icon-angle-right"></i>
            </a>
          </div>
        </div>
        -->
        <div class="widget widget-cats tags">
          <h4 class="widget-title">标签</h4>
          <ul>
          
            <li><a href='/tags/analysis.html'>analysis</a></li>
          
            <li><a href='/tags/lockitron.html'>lockitron</a></li>
          
            <li><a href='/tags/technology.html'>technology</a></li>
          
          </ul>
        </div>
        <div class="widget widget-cats">
          <h4 class="widget-title">
            相关文章
          </h4>
          <ul>
            
            
              <li><a href="/posts/2013-07-18-c-grammar-you-cannot-imagine.html">你无法想象的C语法</a></li>
            
              <li><a href="/posts/2012-12-18-octopress-client-a-better-composition-tool.html">产品随想：octopress客户端 —— Atanasoff</a></li>
            
              <li><a href="/posts/2013-02-18-sdn-elementatory-introduction.html">SDN浅谈</a></li>
            
              <li><a href="/posts/2013-02-21-openflow-introduction.html">Openflow简介</a></li>
            
              <li><a href="/posts/2013-04-25-engineering-environment-for-smart-team.html">自动化的高效团队开发环境</a></li>
            
              <li><a href="/posts/2013-06-10-use-scrapyd-to-serve-scrapy-projects.html">用scrapyd来提供crawler服务</a></li>
            
              <li><a href="/posts/2013-06-12-use-makefile-to-automate-deployment.html">使用Makefile自动化部署</a></li>
            
              <li><a href="/posts/2013-06-23-come-to-origin-for-embedded-applications.html">Come to Origins for Embedded Applications</a></li>
            
              <li><a href="/posts/2012-12-31-atanasoff-product-design.html">进一步思考Atanasoff (Octopress client) (2)</a></li>
            
              <li><a href="/posts/2013-07-22-why-should-c-programmers-learn-erlang.html">Why should C programmers learn Erlang?</a></li>
            
              <li><a href="/posts/2013-10-28-blog-reborn.html">觅珠人：浴火重生</a></li>
            
              <li><a href="/posts/2013-10-30-the-hatch-project.html">Hatch: 又一个建站工具</a></li>
            
              <li><a href="/posts/2013-11-03-hatch-experiment.html">Hatch: 实验</a></li>
            
              <li><a href="/posts/2013-11-11-https.html">使用HTTPS</a></li>
            
              <li><a href="/posts/2013-11-13-local-docker-repo-en.html">Build Your Own Docker Registry with DigitalOcean</a></li>
            
              <li><a href="/posts/2013-11-13-local-docker-repo.html">建立自己的docker repository</a></li>
            
            
          </ul>
        </div>
      </div>
    </div>      
    <div class='col-md-9'>
      <div class='post-single'>
        <!--
        <div class='pre-post-meta'>
          <span>
            <i class='icon-tags'></i>
            in
            <a href='#'>Web Development</a>
          </span>
          <span>
            <i class='icon-user'></i>
            by
            <a href='#'>Tyr Chen</a>
          </span>
          <span>
            <i class='icon-bookmark'></i>
            7 分钟
          </span>
        </div>
        -->
        <h1 class='has-sub-header'>胡思乱想之Lockitron的技术架构</h1>
        <div class='post-single-meta'>
          <span class='meta-item'>
            <i class='icon-calendar'></i>
            10个月前
          </span>
          <!--
          <span class='meta-item'>
            <a href='#'>
              <i class='icon-comments'></i>
              24
            </a>
          </span>
          <span class='meta-item'>
            <a href='#'>
              <i class='icon-heart'></i>
              15
            </a>
          </span>
          -->
          <span class="meta-item">
          	
            <i class='icon-time'></i>
            7 分钟
          </span>
        </div>
        <h2>引子</h2>
<p>有很久没有写文章了。为google I/O在airbnb寻找硅谷附近的住所时无意间遇到了Paul，<a href="http://lockitron.com">lockitron</a> 的创始人。于是lockitron便吸引了我的注意力。他们的video很酷（需翻墙）：</p>
<iframe width="640" height="360" src="http://www.youtube.com/embed/D1L3o88GKew" frameborder="0" allowfullscreen></iframe>

<p>根据这个video及其主页的介绍，我用lean canvas大概总结了一下其要解决的问题和商业思路：<a href="/canvases/2013-04-10-lockitron-canvas.html">Locitron lean canvas</a>。接下来的问题是：如果要做这样一个产品，需要什么样的技术架构？</p>
<p>于是，我花了些时间，深入了解lockitron，思考其特性，及特性背后的feature。我会从硬件——门锁控制器（下称controller），软件——功能与服务（下称service）两个方面来看lockitron面临的技术挑战及解决方案。由于我手头没有一个lockitron供我测试和reverse engineering，所以接下来你看到的内容，臆想的成分很大。</p>
<!--more-->

<h2>硬件——门锁控制器</h2>
<p>我是硬件的门外汉，不懂PCB，但是controller的控制电路本身想来并不太难（please correct me），但是要能通过网络控制门锁门锁，则面临三个棘手的问题：</p>
<ul>
<li>如何接收（甚至发送）控制信号？</li>
<li>如何保证安全性？（信号正确无误，来自被授权的设备，且未被reply）</li>
<li>如何可靠地供电？</li>
</ul>
<p>安全性是一个全局问题，我们最后讨论。</p>
<p>接受来自网络的信号从而控制机械进行开关的动作不算一件很难的事情，有线网络，WiFi，蓝牙，NFC等技术都可以做到。然而要从internet上接收控制信号，且不依赖第三个设备，可选的技术就只有有线和无线网络。有线网络不用考虑，没有易用性。所以Lockitron选择使用WiFi——感谢iPhone/iPad的普及，目前几乎有网络的家庭就会有WiFi。</p>
<p>但是，如何配置controller上的WiFi，使其接入到家里的WiFi网络，从而连接internet？这是我苦苦思索的一个问题。我想到以下solution：</p>
<ol>
<li>为controller额外多提供一个ethernet接口，供第一次部署时访问，就像路由器那样，默认192.168.0.1的IP地址，提供一个简单的WebUI来选择WiFi接入点及输入密码。不过这样多了额外的硬件（和外部接口），用起来也很傻。</li>
<li>为controller提供蓝牙支持。用户可以通过手机连上去，然后在app中设置其WiFi配置。蓝牙的缺点是服务范围有点广，你对门也总能搜到这个蓝牙信号，然后搞点破坏。当然，可以在成功建立WiFi连接后自动关闭蓝牙，然后在丢失WiFi连接后再重新启动。不过似乎还是有不少漏洞。</li>
<li>NFC支持。同2。范围更近一些，应该更安全些。不过别有用心的人可以会拿着手机在你的门上扫...</li>
<li>在面板上提供一个触摸屏。用它来进行配置工作。貌似可行，但造价一下子就上去了。</li>
<li>提供简单的语音支持。也不是很靠谱。而且软硬件成本上去不少。</li>
</ol>
<p>这些解决方案中要我选的话，唯一能接受的是ethernet。除了稍稍SB些，安全性/成本比是最优的。</p>
<p>然而看Lockitron的外观图，并没发现其有ethernet接口（或USB口）。Lockitron是怎么解决这个问题的呢？我多番查证，终于在其官方博客3/23的一篇博文中找到了答案—— <a href="http://electricimp.com/">Electric Imp</a>，又是一个NB创业公司做出来的天才硬件。看看video：</p>
<iframe width="640" height="360" src="http://www.youtube.com/embed/ezFsOBQCcPU" frameborder="0" allowfullscreen></iframe>

<p>Imp是一个SD card大小的网络连接组件，为设备提供安全的互联网连接。Imp为设备制造商解决两个问题：</p>
<ul>
<li>网络连接：Imp card有自己的OS（猜想是个定制的linux或uc/os），内建TLS支持，保证网络传输的安全</li>
<li>轻松部署：Imp有自己的BlinkUp专利技术（待批准），只要将iPhone屏幕贴着Imp，几次闪光后就可将WiFi配置传输到Imp。看这个Video：</li>
</ul>
<iframe width="640" height="360" src="http://www.youtube.com/embed/sVWlQNzU4Ak" frameborder="0" allowfullscreen></iframe>

<p>关于Imp更多的细节请自行访问其官网。也许下次我会尝试着思考Imp的技术架构。</p>
<p>总之，通过使用Imp，controller解决了前两个问题。</p>
<p>供电是另外一个棘手的问题。一般人家的门上不会走电线，也就不可能有电源插口。另外，外部电源并不可靠，你总不想在小区停电的晚上，一个人呆在门口里，绝望地刷微博等待电力恢复吧？所以，电池供电是最好的解决方案。但是，门锁不比iPhone，你不能每天晚上给它充电，然后祈祷它一天之内都能正常工作。最终问题指向了硬件和软件的电力消耗：如何设计足够省电的软硬件，让Lockitron能正常工作一年之久？</p>
<p>答案还是Imp。Imp帮助Lockitron offload了很多事情。由于它能够接收来自internet的信息，比如说一个json:</p>
<pre><code>{
  &quot;action&quot;: &quot;open&quot;
}</code></pre>
<p>通过编程，我们可以将这个消息转换成某个引脚的低电平/高电平信号，从而让controller驱动开关。所以我猜想controller的PCB比较简单，甚至用不到CPU。所以，耗电的压力主要集中在Imp上。看了下Imp的手册，idle状态下10mA以内，rx/tx状态会最高到250mA。10mA只能算是中庸，对于AA充电电池（一般2500mA左右）来说，能待机250小时，10天左右。然而Imp还支持deep sleep，在此状态下只需要6uA的电流，不考虑电池自放电，可以待机47年。在deep sleep状态下，当收到信号时，Imp会启动，连接WiFi，传输数据，然后再转回deep sleep，整个过程耗时1s左右。这对开关锁这样的非实时应用来说足够了，所以，在Imp的帮助下，Lockitron controller能够使用两节AA电池，待机至少1年。当电池电量到达某个阈值时，controller会通过led（猜测）提醒主人更换电池。</p>
<h2>软件——功能与服务</h2>
<p>我们先看看Lockitron的软件都需要做哪些事情：</p>
<ul>
<li>用户和controller注册</li>
<li>权限设置（授权其他用户开锁）</li>
<li>开锁/解锁</li>
<li>事件处理（有人敲门，主人正在接近家门，etc.）</li>
<li>日志</li>
</ul>
<h2>手机应用</h2>
<p>解决了以上问题，剩下的就是如何user friendly。在Video中Lockitron的控制器甚至能被各种各样的终端控制，不单单限制在手机上。但人人都有手机，所以Lockitron提供了iOS, Android甚至text message的支持。作为创业公司，Lockitron的做法很讨巧，就提供了一套手机端的html5页面。使用起来是否足够友好和流畅我不得而知，因为我只能打开login的页面。但Lockitron的控制目前还相对简单，所以WebUI足矣。</p>
<p>（未完待续）</p>

        <div class="subscribe">
          <p>如果您对本站的文章感兴趣，欢迎订阅我的微博公共账号：程序人生。每次博文发表时，您都能获得通知。此外，公共账号还会不定期推送一些短文，技术心得，供您参考。</p>
          <img src="/assets/files/weixin.jpg" width="150px" />
        </div>
        <div class='under-post'>
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
                
                  <div class='pull-left'>
                    <a class='read-previous-link' href='/posts/2013-03-19-taking-baby-to-vacation.html'>
                      <i class='icon-angle-left'></i>
                      上一篇
                    </a>
                  </div>                  
                
                
                  <div class='pull-right'>
                    <a class='read-next-link' href='/posts/2013-04-25-engineering-environment-for-smart-team.html'>
                      下一篇
                      <i class='icon-angle-right'></i>
                    </a>
                  </div>
                         
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          
          <div class='post-social text-center'>
  <a class='social-link' href='#'>
    <i class='icon-weibo'></i>
  </a>
  <a class='social-link' href='#'>
    <i class='icon-envelope'></i>
  </a>
</div>
        </div>
        <div class='separator-shadow-bottom'>
    <img alt='' src='/assets/images/shadow-separator-wide-bottom.png'>
</div>
        
  <div class="ds-thread">
    <script>
        var duoshuoQuery = {short_name:"tyrchen"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
  </div>

    
      </div>
    </div>


  </div>
</div>

<footer id="main-footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <ul class="footer-menu">
                    <li><a href="/pages/privacy">隐私策略</a></li>
                    <li><a href="/pages/license">版权说明</a></li>
                    <li><a href="/pages/disclaimer">免责声明</a></li>
                    <li><a href="#">联系我们</a></li>
                </ul>
                <div class="copyright">
                    2014 &copy; Tyr Chen. 保留一切权利.
                    <script>
                        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
                        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F639096b5979f5825515e0f88f871f56c' type='text/javascript'%3E%3C/script%3E"));
                    </script>
                </div>
            </div>
            <div class="col-md-6">
                <ul class="footer-social">
                
                    <li><a href="tyr.chen{#}gmail.com" target="_blank"><i class="icon-envelope"></i></a></li>
                
                    <li><a href="http://weibo.com/tchen82" target="_blank"><i class="icon-weibo"></i></a></li>
                
                    <li><a href="http://github.com/tyrchen" target="_blank"><i class="icon-github"></i></a></li>
                
                    <li><a href="http://linkedin.com/in/tyrchen/" target="_blank"><i class="icon-linkedin"></i></a></li>
                
                    <li><a href="https://twitter.com/tyrchen" target="_blank"><i class="icon-twitter"></i></a></li>
                
                    <li><a href="https://www.facebook.com/tyrchen" target="_blank"><i class="icon-facebook"></i></a></li>
                
                    <li><a href="https://plus.google.com/114684266209262341260/" target="_blank"><i class="icon-google-plus"></i></a></li>
                
                </ul>
            </div>
        </div>
    </div>
</footer>

<!-- Scripts -->
<script defer="defer"  src="/assets/js/app.min.js"></script>

<script defer="defer" language="javascript">

</script>
</body>

</html>